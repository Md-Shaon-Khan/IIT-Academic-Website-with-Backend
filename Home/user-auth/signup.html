<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Signup</title>
    <link rel="stylesheet" href="signup.css">
</head>
<body>
<div class="card">
    <h2>Admin Signup</h2>
    <p class="subtitle">Only authorized emails can register.</p>

    <div class="step-indicator">
        <div class="step-dot active" id="dot1"></div>
        <div class="step-dot" id="dot2"></div>
    </div>

    <!-- STEP 1 -->
    <div id="step1">
        <div class="input-group">
            <input type="email" id="email" required>
            <label>Work Email</label>
        </div>
        <button id="sendOtpBtn" onclick="sendOTP()">Send Verification Code</button>
    </div>

    <!-- STEP 2 -->
    <div id="step2" class="hidden">
        <p style="font-size:0.7rem; color:#ffffff; margin-bottom:1rem;">
            A 6-digit code was sent to <strong id="displayEmail"></strong>
        </p>

        <div class="input-group">
            <input type="text" id="otp" maxlength="6" required>
            <label>Verification Code</label>
        </div>
        <div id="timer">Code expires in <span id="countdown">10:00</span></div>

        <div class="input-group">
            <input type="text" id="username" required>
            <label>Username</label>
        </div>

        <div class="input-group">
            <input type="password" id="password" required>
            <label>Password</label>
        </div>

        <div class="input-group">
            <input type="password" id="confirmPassword" required>
            <label>Confirm Password</label>
        </div>

        <button id="signupBtn" onclick="submitSignup()">Create Account</button>

        <p style="text-align:center; margin-top:1rem; font-size:0.85rem; color:#ffffff;">
            Wrong email? <a href="#" onclick="resetToStep1()" style="color:#1a5382;">Go back</a>
        </p>
    </div>

    <div class="msg" id="msgBox"></div>
</div>

<script>
    const API = "http://127.0.0.1:8000";
    let timerInterval = null;

    function showMsg(text, type) {
        const box = document.getElementById("msgBox");
        box.textContent = text;
        box.className = `msg ${type}`;
        box.style.display = "block";
    }

    function clearMsg() {
        const box = document.getElementById("msgBox");
        box.style.display = "none";
    }

    async function sendOTP() {
        const email = document.getElementById("email").value.trim();
        if (!email) return showMsg("Please enter your email.", "error");

        const btn = document.getElementById("sendOtpBtn");
        btn.disabled = true;
        btn.textContent = "Sending...";
        clearMsg();

        const formData = new FormData();
        formData.append("email", email);

        try {
            const res = await fetch(`${API}/auth/request-otp`, {
                method: "POST",
                body: formData
            });
            const data = await res.json();

            if (!res.ok) {
                showMsg(data.detail, "error");
                btn.disabled = false;
                btn.textContent = "Send Verification Code";
                return;
            }

            // Move to step 2
            document.getElementById("step1").classList.add("hidden");
            document.getElementById("step2").classList.remove("hidden");
            document.getElementById("displayEmail").textContent = email;
            document.getElementById("dot2").classList.add("active");

            startCountdown(10 * 60); // 10 minutes

        } catch (e) {
            showMsg("Network error. Please try again.", "error");
            btn.disabled = false;
            btn.textContent = "Send Verification Code";
        }
    }

    function startCountdown(seconds) {
        clearInterval(timerInterval);
        const display = document.getElementById("countdown");

        timerInterval = setInterval(() => {
            const m = Math.floor(seconds / 60).toString().padStart(2, "0");
            const s = (seconds % 60).toString().padStart(2, "0");
            display.textContent = `${m}:${s}`;

            if (seconds <= 0) {
                clearInterval(timerInterval);
                display.textContent = "Expired";
                showMsg("OTP expired. Please go back and request a new one.", "error");
            }
            seconds--;
        }, 1000);
    }

    async function submitSignup() {
        const email = document.getElementById("email").value.trim();
        const otp = document.getElementById("otp").value.trim();
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;
        const confirmPassword = document.getElementById("confirmPassword").value;

        if (!otp || !username || !password) return showMsg("All fields are required.", "error");
        if (password !== confirmPassword) return showMsg("Passwords do not match.", "error");
        if (password.length < 6) return showMsg("Password must be at least 6 characters.", "error");

        const btn = document.getElementById("signupBtn");
        btn.disabled = true;
        btn.textContent = "Creating Account...";
        clearMsg();

        const formData = new FormData();
        formData.append("email", email);
        formData.append("otp", otp);
        formData.append("username", username);
        formData.append("password", password);

        try {
            const res = await fetch(`${API}/auth/signup`, {
                method: "POST",
                body: formData
            });
            const data = await res.json();

            if (!res.ok) {
                showMsg(data.detail, "error");
                btn.disabled = false;
                btn.textContent = "Create Account";
                return;
            }

            clearInterval(timerInterval);
            showMsg("Account created! Redirecting to login...", "success");

            setTimeout(() => window.location.href = "login.html", 2000);

        } catch (e) {
            showMsg("Network error. Please try again.", "error");
            btn.disabled = false;
            btn.textContent = "Create Account";
        }
    }

    function resetToStep1() {
        clearInterval(timerInterval);
        document.getElementById("step2").classList.add("hidden");
        document.getElementById("step1").classList.remove("hidden");
        document.getElementById("dot2").classList.remove("active");
        document.getElementById("sendOtpBtn").disabled = false;
        document.getElementById("sendOtpBtn").textContent = "Send Verification Code";
        clearMsg();
    }
</script>
</body>
</html>
